<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arena - aiXiv</title>
<link rel="stylesheet" href="/static/style.css">
<style>
.arena-container { max-width: 1000px; margin: 0 auto; padding: 32px 20px; }
.arena-hero { text-align: center; margin-bottom: 32px; }
.arena-hero h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
.arena-hero h1 .accent { color: var(--accent); }
.arena-hero p { font-size: 15px; color: var(--text-muted); max-width: 600px; margin: 0 auto; }

.arena-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px; }
.info-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; box-shadow: var(--shadow); }
.info-val { font-size: 32px; font-weight: 700; color: var(--accent); }
.info-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

.filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.filter-bar select, .filter-bar input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; }
.filter-bar input { flex: 1; min-width: 200px; }

.arena-table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); }
.arena-table th { background: var(--code-bg); padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); cursor: pointer; user-select: none; }
.arena-table th:hover { color: var(--accent); }
.arena-table td { padding: 12px 16px; border-top: 1px solid var(--border); font-size: 14px; vertical-align: top; }
.arena-table tr:hover td { background: var(--code-bg); }

.rank-num { font-size: 20px; font-weight: 700; color: var(--accent); }
.rank-1 { color: #f9a825; }
.rank-2 { color: #9e9e9e; }
.rank-3 { color: #bf8040; }

.paper-title-link { font-weight: 600; color: var(--text); text-decoration: none; }
.paper-title-link:hover { color: var(--accent); }
.paper-authors { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

.score-pill { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 13px; font-weight: 700; }
.score-high { background: #e8f5e9; color: #2e7d32; }
.score-mid { background: #e3f2fd; color: #1565c0; }
.score-low { background: #fff8e1; color: #f57f17; }

.maturity-pill { display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 700; color: white; }
.maturity-pill.l0 { background: #9e9e9e; } .maturity-pill.l1 { background: #f57c00; }
.maturity-pill.l2 { background: #fbc02d; color: #333; } .maturity-pill.l3 { background: #43a047; }
.maturity-pill.l4 { background: #1565c0; } .maturity-pill.l5 { background: #6a1b9a; }

.badge { display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; margin-right: 4px; margin-top: 4px; }
.badge-certified { background: #e3f2fd; color: #1565c0; }
.badge-redteam { background: #e8f5e9; color: #2e7d32; }
.badge-rail { background: #f3e5f5; color: #6a1b9a; }

.btn-outline { background: white; color: var(--accent); border: 1px solid var(--accent); padding: 6px 14px; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; }
.btn-outline:hover { background: var(--accent); color: white; }
.empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
.empty-state h3 { font-size: 20px; margin-bottom: 8px; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <a href="/" class="logo">ai<span class="logo-accent">X</span>iv</a>
    <nav>
      <a href="/">Papers</a>
      <a href="https://github.com/integritynoble/Physics_World_Model" target="_blank">Physics_World_Model</a>
      <a href="/profile">Profile</a>
    </nav>
  </div>
</header>

{% include '_auth_bar.html' %}
{% include '_settings_modal.html' %}

<main class="arena-container">
  <div class="arena-hero">
    <h1>The <span class="accent">Arena</span></h1>
    <p>Tier 2: AI-reviewed and quality-verified papers ranked by composite review score. Only papers that pass the full review pipeline are promoted here.</p>
  </div>

  <div class="arena-info">
    <div class="info-card"><div class="info-val" id="stat-count">0</div><div class="info-label">Arena Papers</div></div>
    <div class="info-card"><div class="info-val" id="stat-avg">0</div><div class="info-label">Avg Score</div></div>
    <div class="info-card"><div class="info-val" id="stat-top">-</div><div class="info-label">Top Maturity</div></div>
  </div>

  <div class="filter-bar">
    <input type="text" id="search" placeholder="Search papers..." oninput="filterTable()">
    <select id="filter-maturity" onchange="filterTable()">
      <option value="">All Maturity Levels</option>
      <option value="L0">L0</option><option value="L1">L1</option><option value="L2">L2</option>
      <option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option>
    </select>
  </div>

  <table class="arena-table" id="arena-table">
    <thead>
      <tr>
        <th><input type="checkbox" id="select-all" onchange="toggleSelectAll(this)"></th>
        <th onclick="sortBy('rank')">#</th>
        <th onclick="sortBy('title')">Paper</th>
        <th onclick="sortBy('score')">Score</th>
        <th onclick="sortBy('maturity')">Maturity</th>
        <th>Badges</th>
      </tr>
    </thead>
    <tbody id="arena-body"></tbody>
  </table>

  <div class="empty-state" id="empty-state" style="display:none">
    <h3>No papers in the Arena yet</h3>
    <p>Papers are promoted to the Arena after passing the full AI review pipeline.<br>
    Submit and review papers through the <a href="/reviewer" style="color:var(--accent)">Reviewer</a> page.</p>
  </div>

  <!-- Comparison Panel -->
  <div id="compare-panel" style="display:none; margin-top:24px">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
      <h3 style="margin:0">Paper Comparison</h3>
      <button class="btn-outline" onclick="clearComparison()" style="font-size:12px">Clear</button>
    </div>
    <div style="text-align:center;margin-bottom:16px">
      <canvas id="compare-radar" width="340" height="340" style="display:none"></canvas>
      <div id="radar-legend" style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:8px;font-size:12px"></div>
    </div>
    <div id="compare-results" style="display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr))"></div>
  </div>
</main>

<footer>
  <div class="footer-inner">
    <p>aiXiv AI Scientist â€” powered by the SolveEverything.org framework</p>
    <p>Operated by NextGen PlatformAI C Corp</p>
  </div>
</footer>

<script>
let papers = [];
let sortField = 'score';
let sortDir = -1;

function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

async function loadArena() {
  try {
    const resp = await fetch('/api/arena');
    papers = await resp.json();
  } catch(e) { papers = []; }
  renderTable();
  updateStats();
}

function updateStats() {
  document.getElementById('stat-count').textContent = papers.length;
  if (papers.length) {
    const avg = papers.reduce((s,p) => s + (p.review_score||0), 0) / papers.length;
    document.getElementById('stat-avg').textContent = avg.toFixed(1);
    const levels = ['L5','L4','L3','L2','L1','L0'];
    const top = levels.find(l => papers.some(p => p.maturity_level === l)) || '-';
    document.getElementById('stat-top').textContent = top;
  }
}

function scoreClass(score) {
  if (score >= 7) return 'score-high';
  if (score >= 5) return 'score-mid';
  return 'score-low';
}

function badgeHtml(badges) {
  if (!badges || !badges.length) return '';
  return badges.map(b => {
    let cls = 'badge-certified';
    if (b.includes('Red')) cls = 'badge-redteam';
    if (b.includes('Rail')) cls = 'badge-rail';
    return '<span class="badge '+cls+'">'+esc(b)+'</span>';
  }).join(' ');
}

function renderTable() {
  const search = document.getElementById('search').value.toLowerCase();
  const matFilter = document.getElementById('filter-maturity').value;
  let filtered = papers.filter(p => {
    if (matFilter && p.maturity_level !== matFilter) return false;
    if (search && !(p.title||'').toLowerCase().includes(search) && !(p.authors||'').toLowerCase().includes(search)) return false;
    return true;
  });

  filtered.sort((a,b) => {
    let va = a[sortField], vb = b[sortField];
    if (typeof va === 'string') return sortDir * va.localeCompare(vb);
    return sortDir * ((va||0) - (vb||0));
  });

  const tbody = document.getElementById('arena-body');
  if (!filtered.length) {
    tbody.innerHTML = '';
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('arena-table').style.display = 'none';
    return;
  }
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('arena-table').style.display = 'table';

  tbody.innerHTML = filtered.map((p, i) => {
    const rank = i + 1;
    const rankCls = rank <= 3 ? ' rank-' + rank : '';
    const score = (p.review_score || 0).toFixed(1);
    const ml = (p.maturity_level || 'L0').toLowerCase();
    const badges = Array.isArray(p.badges) ? p.badges : [];
    return '<tr>' +
      '<td><input type="checkbox" class="compare-cb" value="'+esc(p.paper_id||'')+'" onchange="onCompareCheck()"></td>' +
      '<td><span class="rank-num'+rankCls+'">' + rank + '</span></td>' +
      '<td><a class="paper-title-link" href="#">' + esc(p.title||'') + '</a><div class="paper-authors">' + esc(p.authors||'') + ' | ' + esc(p.paper_id||'') + '</div></td>' +
      '<td><span class="score-pill ' + scoreClass(p.review_score||0) + '">' + score + '</span></td>' +
      '<td><span class="maturity-pill ' + ml + '">' + (p.maturity_level||'L0') + '</span></td>' +
      '<td>' + badgeHtml(badges) + '</td>' +
      '</tr>';
  }).join('');
}

function filterTable() { renderTable(); }
function sortBy(field) {
  if (sortField === field) sortDir *= -1;
  else { sortField = field; sortDir = -1; }
  renderTable();
}

function toggleSelectAll(cb) {
  document.querySelectorAll('.compare-cb').forEach(c => c.checked = cb.checked);
  onCompareCheck();
}

function onCompareCheck() {
  const checked = [...document.querySelectorAll('.compare-cb:checked')].map(c => c.value);
  const panel = document.getElementById('compare-panel');
  if (checked.length >= 2) {
    panel.style.display = 'block';
    loadComparison(checked);
  } else {
    panel.style.display = 'none';
  }
}

function clearComparison() {
  document.querySelectorAll('.compare-cb').forEach(c => c.checked = false);
  document.getElementById('select-all').checked = false;
  document.getElementById('compare-panel').style.display = 'none';
}

const RADAR_COLORS = ['#b71c1c','#1565c0','#2e7d32','#f57c00','#6a1b9a'];

function drawCompareRadar(papers) {
  const canvas = document.getElementById('compare-radar');
  if (!canvas || !papers.length) { canvas.style.display='none'; return; }
  const dims = ['soundness','novelty','clarity','significance','reproducibility'];
  // Check if any paper has scores
  const hasScores = papers.some(p => dims.some(d => (p.scores&&p.scores[d]) > 0));
  if (!hasScores) { canvas.style.display='none'; return; }

  canvas.style.display = 'block';
  const ctx = canvas.getContext('2d');
  const W=canvas.width, H=canvas.height, cx=W/2, cy=H/2, R=120;
  ctx.clearRect(0,0,W,H);
  const n=dims.length, step=2*Math.PI/n, offset=-Math.PI/2;

  // Grid
  [0.2,0.4,0.6,0.8,1.0].forEach(r=>{
    ctx.beginPath();
    for(let i=0;i<=n;i++){const a=offset+i*step; ctx.lineTo(cx+R*r*Math.cos(a),cy+R*r*Math.sin(a));}
    ctx.closePath(); ctx.strokeStyle='#ddd'; ctx.lineWidth=1; ctx.stroke();
  });

  // Axes + labels
  ctx.font='12px sans-serif'; ctx.fillStyle='#666'; ctx.textAlign='center';
  dims.forEach((d,i)=>{
    const a=offset+i*step;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+R*Math.cos(a),cy+R*Math.sin(a));
    ctx.strokeStyle='#ccc'; ctx.stroke();
    const lx=cx+(R+22)*Math.cos(a), ly=cy+(R+22)*Math.sin(a);
    ctx.fillText(d.charAt(0).toUpperCase()+d.slice(1),lx,ly+4);
  });

  // Data polygons for each paper
  papers.forEach((p,pi)=>{
    const color = RADAR_COLORS[pi % RADAR_COLORS.length];
    const vals = dims.map(d => (p.scores&&p.scores[d])||0);
    ctx.beginPath();
    vals.forEach((v,i)=>{
      const a=offset+i*step, r=R*(v/10);
      if(i===0) ctx.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a));
      else ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));
    });
    ctx.closePath();
    ctx.fillStyle=color+'33'; ctx.fill();
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.stroke();
    // Points
    vals.forEach((v,i)=>{
      const a=offset+i*step, r=R*(v/10);
      ctx.beginPath(); ctx.arc(cx+r*Math.cos(a),cy+r*Math.sin(a),3,0,2*Math.PI);
      ctx.fillStyle=color; ctx.fill();
    });
  });

  // Legend
  document.getElementById('radar-legend').innerHTML = papers.map((p,i)=>{
    const color = RADAR_COLORS[i % RADAR_COLORS.length];
    return '<div><span style="display:inline-block;width:12px;height:12px;border-radius:2px;background:'+color+';vertical-align:middle;margin-right:4px"></span>'+esc((p.title||'').substring(0,30))+'</div>';
  }).join('');
}

async function loadComparison(ids) {
  try {
    const resp = await fetch('/api/arena/compare?paper_ids=' + encodeURIComponent(ids.join(',')));
    const data = await resp.json();
    drawCompareRadar(data);
    const dims = ['soundness','novelty','clarity','significance','reproducibility','overall'];
    let html = '';
    data.forEach(p => {
      const ml = (p.maturity_level||'L0').toLowerCase();
      html += '<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:16px">';
      html += '<div style="font-weight:700;margin-bottom:4px">'+esc(p.title||'')+'</div>';
      html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">'+esc(p.authors||'')+' | '+esc(p.paper_id||'')+'</div>';
      html += '<div style="margin-bottom:8px"><span class="maturity-pill '+ml+'">'+(p.maturity_level||'L0')+'</span>';
      if (p.arena_score!=null) html += ' <span class="score-pill '+scoreClass(p.arena_score)+'">'+p.arena_score.toFixed(1)+'</span>';
      html += '</div>';
      // Mini score bars
      dims.forEach(d => {
        const val = (p.scores && p.scores[d]) || 0;
        const pct = (val/10)*100;
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;font-size:12px">';
        html += '<span style="width:90px;text-align:right;color:var(--text-muted)">'+d+'</span>';
        html += '<div style="flex:1;height:8px;background:var(--code-bg);border-radius:4px;overflow:hidden"><div style="width:'+pct+'%;height:100%;background:var(--accent);border-radius:4px"></div></div>';
        html += '<span style="width:24px;font-weight:700">'+val+'</span></div>';
      });
      if (p.badges && p.badges.length) {
        html += '<div style="margin-top:8px">'+badgeHtml(p.badges)+'</div>';
      }
      html += '</div>';
    });
    document.getElementById('compare-results').innerHTML = html;
  } catch(e) { console.error('Comparison failed:', e); }
}

loadArena();
</script>
</body>
</html>
