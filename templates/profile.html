<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - aiXiv</title>
<link rel="stylesheet" href="/static/style.css">
<style>
.profile-container { max-width: 860px; margin: 0 auto; padding: 32px 20px; }
.profile-hero { text-align: center; margin-bottom: 32px; }
.profile-hero h1 { font-size: 32px; font-weight: 700; margin-bottom: 6px; }
.profile-hero h1 .accent { color: var(--accent); }
.profile-hero p { font-size: 15px; color: var(--text-muted); }

.card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); margin-bottom: 20px; }
.card h3 { font-size: 17px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

.profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 700px) { .profile-grid { grid-template-columns: 1fr; } }

.avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #6a1b9a); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; color: white; margin: 0 auto 16px auto; }
.info-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
.info-row:last-child { border-bottom: none; }
.info-label { color: var(--text-muted); font-size: 13px; }
.info-val { font-weight: 600; }
.info-val.badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 12px; }
.badge-sso { background: #e3f2fd; color: #1565c0; }
.badge-local { background: #f3e5f5; color: #6a1b9a; }
.badge-role { background: #e8f5e9; color: #2e7d32; }

.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.4px; color: var(--text-muted); }
.form-group input, .form-group select { width: 100%; padding: 9px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-family: inherit; box-sizing: border-box; background: var(--card-bg); color: var(--text); }
.form-group input[type="password"] { letter-spacing: 2px; }

.btn-primary { background: var(--accent); color: white; border: none; padding: 10px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
.btn-primary:hover { opacity: 0.9; }
.btn-outline { background: transparent; color: var(--accent); border: 1px solid var(--accent); padding: 10px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; }
.btn-outline:hover { background: var(--accent); color: white; }
.btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
.btn-danger { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
.btn-danger:hover { background: #c62828; color: white; }

.msg { padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-top: 10px; display: none; }
.msg.ok { background: #e8f5e9; color: #2e7d32; }
.msg.err { background: #ffebee; color: #c62828; }

.credit-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-top: 6px; }
.credit-fill { height: 100%; background: linear-gradient(to right, var(--accent), #6a1b9a); border-radius: 4px; transition: width 0.5s; }

.sso-btn { display: flex; align-items: center; gap: 10px; padding: 12px 20px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; color: #333; text-decoration: none; width: 100%; justify-content: center; margin-bottom: 10px; }
.sso-btn:hover { background: var(--code-bg); }

.divider { display: flex; align-items: center; gap: 12px; margin: 16px 0; color: var(--text-muted); font-size: 13px; }
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.tab-bar { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
.tab-btn { padding: 8px 18px; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; background: none; border-left: none; border-right: none; border-top: none; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <a href="/" class="logo">ai<span class="logo-accent">X</span>iv</a>
    <nav>
      <a href="/">Papers</a>
      <a href="/pwm">PWM</a>
      <a href="/targeting">Targeting</a>
      <a href="/profile" class="active">Profile</a>
    </nav>
  </div>
</header>

{% include '_auth_bar.html' %}
{% include '_settings_modal.html' %}

<div class="profile-container">
  <div class="profile-hero">
    <h1>User <span class="accent">Profile</span></h1>
    <p>Manage your account and API keys</p>
  </div>

  {% if user %}
  <!-- ══════════ Logged-in view ══════════ -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('account', this)">Account</button>
    <button class="tab-btn" onclick="switchTab('apikeys', this)">API Keys</button>
  </div>

  <!-- Account Tab -->
  <div class="tab-pane active" id="tab-account">
    <div class="profile-grid">
      <!-- User Identity Card -->
      <div class="card">
        <div class="avatar">{{ (user.user_name or user.user_id or 'U')[0]|upper }}</div>
        <h3 style="margin-bottom:4px;justify-content:center">{{ user.user_name or user.user_id }}</h3>
        <div style="font-size:13px;color:var(--text-muted);text-align:center;margin-bottom:20px">
          {% if user.user_id.startswith('local_') %}
            <span class="info-val badge badge-local">Local Account</span>
          {% else %}
            <span class="info-val badge badge-sso">CompareGPT SSO</span>
          {% endif %}
        </div>

        <div class="info-row">
          <span class="info-label">User ID</span>
          <span class="info-val" style="font-size:13px;font-family:monospace">{{ user.user_id }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Display Name</span>
          <span class="info-val">{{ user.user_name or '—' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Role</span>
          <span class="info-val badge badge-role">{{ user.role or 'user' }}</span>
        </div>
        <div class="btn-row" style="margin-top:20px;justify-content:center">
          <a href="/api/auth/logout" class="btn-outline">Sign Out</a>
        </div>
      </div>

      <!-- Account Details Card -->
      <div class="card">
        <h3>Account Details</h3>

        {% if not user.user_id.startswith('local_') %}
        <!-- SSO user: show credits and token balance -->
        <div class="info-row">
          <span class="info-label">Credits</span>
          <span class="info-val" id="credit-val">{{ '%.2f'|format(user.credit|default(0, true)|float) }}</span>
        </div>
        <div class="credit-bar"><div class="credit-fill" id="credit-bar-fill" style="width:0%"></div></div>
        <div class="info-row">
          <span class="info-label">Tokens</span>
          <span class="info-val">{{ '%.2f'|format(user.token|default(0, true)|float) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">SSO API Key</span>
          <span class="info-val" style="font-size:12px">
            {% if db_user and db_user.api_key %}
              {{ db_user.api_key[:8] }}...{{ db_user.api_key[-4:] }}
            {% else %}
              Not set
            {% endif %}
          </span>
        </div>
        {% endif %}

        <div class="info-row">
          <span class="info-label">Active Provider</span>
          <span class="info-val">{% if user.effective_provider %}{{ user.effective_provider }}{% else %}None{% endif %}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Custom API Key</span>
          <span class="info-val">{% if user.effective_api_key and (db_user and db_user.custom_api_key) %}Configured{% else %}Not set{% endif %}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Member Since</span>
          <span class="info-val">{% if db_user and db_user.created_at %}{{ db_user.created_at[:10] }}{% else %}—{% endif %}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Last Updated</span>
          <span class="info-val">{% if db_user and db_user.updated_at %}{{ db_user.updated_at[:10] }}{% else %}—{% endif %}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- API Keys Tab -->
  <div class="tab-pane" id="tab-apikeys">
    <div class="card">
      <h3>API Key Configuration</h3>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:20px">
        Override the SSO-provided API key with your own. Your key is stored securely and used for all LLM calls (PWM analysis, targeting assessments, etc.).
      </p>
      <div class="form-group">
        <label>Provider</label>
        <select id="profile-provider">
          <option value="">Use SSO key (default)</option>
          <option value="comparegpt">CompareGPT</option>
          <option value="openai">OpenAI</option>
          <option value="anthropic">Anthropic</option>
        </select>
      </div>
      <div class="form-group">
        <label>API Key</label>
        <input id="profile-apikey" type="password" placeholder="sk-... or cgpt_...">
      </div>
      <div class="btn-row">
        <button class="btn-primary" onclick="saveProfileKey()">Save API Key</button>
        <button class="btn-danger" onclick="clearProfileKey()">Clear Key</button>
      </div>
      <div class="msg" id="apikey-msg"></div>
    </div>
    <div class="card">
      <h3>Current Key Status</h3>
      <div class="info-row">
        <span class="info-label">Custom Provider</span>
        <span class="info-val">{% if db_user and db_user.custom_api_provider %}{{ db_user.custom_api_provider }}{% else %}—{% endif %}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Custom Key</span>
        <span class="info-val">
          {% if db_user and db_user.custom_api_key %}
            {{ db_user.custom_api_key[:6] }}...{{ db_user.custom_api_key[-4:] }}
          {% else %}
            Not configured
          {% endif %}
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">Effective Key Source</span>
        <span class="info-val">
          {% if db_user and db_user.custom_api_key %}
            Custom ({{ db_user.custom_api_provider or 'unknown' }})
          {% elif db_user and db_user.api_key %}
            SSO (CompareGPT)
          {% else %}
            None configured
          {% endif %}
        </span>
      </div>
    </div>
  </div>

  {% else %}
  <!-- ══════════ Logged-out view ══════════ -->
  <div class="profile-grid">
    <!-- Sign In -->
    <div class="card">
      <h3>Sign In</h3>
      <a href="/login" class="sso-btn">Sign in with CompareGPT SSO</a>
      <div class="divider">or use local account</div>
      <div class="form-group"><label>Username</label><input type="text" id="login-username" placeholder="your_username"></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-password" placeholder="••••••••"></div>
      <div class="btn-row"><button class="btn-primary" onclick="localLogin()" style="width:100%">Sign In</button></div>
      <div class="msg" id="login-msg"></div>
    </div>

    <!-- Register -->
    <div class="card">
      <h3>Create Account</h3>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Register a local account or use CompareGPT SSO for full features including AI credits.</p>
      <div class="form-group"><label>Username</label><input type="text" id="reg-username" placeholder="your_username"></div>
      <div class="form-group"><label>Email (optional)</label><input type="email" id="reg-email" placeholder="your@email.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="reg-password" placeholder="Min 8 characters"></div>
      <div class="form-group"><label>Confirm Password</label><input type="password" id="reg-confirm" placeholder="Repeat password"></div>
      <div class="btn-row"><button class="btn-primary" onclick="localRegister()" style="width:100%">Create Account</button></div>
      <div class="msg" id="reg-msg"></div>
    </div>
  </div>
  {% endif %}
</div>

<footer>
  <div class="footer-inner">
    <p>aiXiv — Open Research Archive</p>
    <p>Operated by NextGen PlatformAI C Corp</p>
  </div>
</footer>

<script>
function switchTab(id, btn) {
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  btn.classList.add('active');
}

// Credit bar fill
const creditEl = document.getElementById('credit-val');
const fillEl = document.getElementById('credit-bar-fill');
if (creditEl && fillEl) {
  const credit = parseFloat(creditEl.textContent || '0');
  fillEl.style.width = Math.min(credit / 50 * 100, 100) + '%';
}

// API key management
async function saveProfileKey() {
  const provider = document.getElementById('profile-provider').value;
  const apiKey = document.getElementById('profile-apikey').value;
  const msg = document.getElementById('apikey-msg');
  try {
    const resp = await fetch('/api/auth/apikey', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({provider, api_key:apiKey})});
    const data = await resp.json();
    msg.style.display='block';
    if (resp.ok) { msg.className='msg ok'; msg.textContent='API key saved! Reload to see updated status.'; }
    else { msg.className='msg err'; msg.textContent=data.detail||'Failed to save'; }
  } catch(e) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Network error'; }
}

async function clearProfileKey() {
  document.getElementById('profile-provider').value='';
  document.getElementById('profile-apikey').value='';
  await saveProfileKey();
}

// Local login
async function localLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const msg = document.getElementById('login-msg');
  if (!username || !password) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Please enter username and password'; return; }
  try {
    const resp = await fetch('/api/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username, password})});
    const data = await resp.json();
    if (resp.ok) { window.location.href='/profile'; }
    else { msg.className='msg err'; msg.style.display='block'; msg.textContent=data.detail||'Login failed'; }
  } catch(e) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Network error'; }
}

// Local registration
async function localRegister() {
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const confirm = document.getElementById('reg-confirm').value;
  const msg = document.getElementById('reg-msg');
  if (!username || !password) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Username and password are required'; return; }
  if (password !== confirm) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Passwords do not match'; return; }
  if (password.length < 8) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Password must be at least 8 characters'; return; }
  try {
    const resp = await fetch('/api/auth/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username, email, password})});
    const data = await resp.json();
    if (resp.ok) { msg.className='msg ok'; msg.style.display='block'; msg.textContent='Account created!'; setTimeout(()=>window.location.href='/profile',1000); }
    else { msg.className='msg err'; msg.style.display='block'; msg.textContent=data.detail||'Registration failed'; }
  } catch(e) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Network error'; }
}
</script>
</body>
</html>
