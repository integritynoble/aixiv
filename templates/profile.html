<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - aiXiv</title>
<link rel="stylesheet" href="/static/style.css">
<style>
.profile-container { max-width: 860px; margin: 0 auto; padding: 32px 20px; }
.profile-hero { text-align: center; margin-bottom: 32px; }
.profile-hero h1 { font-size: 32px; font-weight: 700; margin-bottom: 6px; }
.profile-hero h1 .accent { color: var(--accent); }
.profile-hero p { font-size: 15px; color: var(--text-muted); }

.card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); margin-bottom: 20px; }
.card h3 { font-size: 17px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

.profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 700px) { .profile-grid { grid-template-columns: 1fr; } }

.avatar { width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #6a1b9a); display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; color: white; margin-bottom: 12px; }
.stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
.stat-row:last-child { border-bottom: none; }
.stat-label { color: var(--text-muted); }
.stat-val { font-weight: 600; }

.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.4px; color: var(--text-muted); }
.form-group input, .form-group select { width: 100%; padding: 9px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-family: inherit; box-sizing: border-box; background: var(--card-bg); color: var(--text); }
.form-group input[type="password"] { letter-spacing: 2px; }

.btn-primary { background: var(--accent); color: white; border: none; padding: 10px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
.btn-primary:hover { opacity: 0.9; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-outline { background: transparent; color: var(--accent); border: 1px solid var(--accent); padding: 10px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
.btn-outline:hover { background: var(--accent); color: white; }
.btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
.btn-danger { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
.btn-danger:hover { background: #c62828; color: white; }

.tab-bar { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
.tab-btn { padding: 8px 18px; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; background: none; border-left: none; border-right: none; border-top: none; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

.msg { padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-top: 10px; display: none; }
.msg.ok { background: #e8f5e9; color: #2e7d32; }
.msg.err { background: #ffebee; color: #c62828; }

.sso-btn { display: flex; align-items: center; gap: 10px; padding: 12px 20px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; color: #333; text-decoration: none; width: 100%; justify-content: center; margin-bottom: 10px; }
.sso-btn:hover { background: var(--code-bg); }
.sso-icon { font-size: 20px; }

.divider { display: flex; align-items: center; gap: 12px; margin: 16px 0; color: var(--text-muted); font-size: 13px; }
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.activity-item { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.activity-item:last-child { border-bottom: none; }
.activity-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
.activity-text { flex: 1; }
.activity-time { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

.credit-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-top: 6px; }
.credit-fill { height: 100%; background: linear-gradient(to right, var(--accent), #6a1b9a); border-radius: 4px; transition: width 0.5s; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <a href="/" class="logo">ai<span class="logo-accent">X</span>iv</a>
    <nav>
      <a href="/">Papers</a>
      <a href="/scientist">AI Scientist</a>
      <a href="/reviewer">AI Reviewer</a>
      <a href="/pwm">PWM</a>
      <a href="/arena">Arena</a>
      <a href="/targeting">Targeting</a>
      <a href="/dashboard">Dashboard</a>
    </nav>
  </div>
</header>

{% include '_auth_bar.html' %}
{% include '_settings_modal.html' %}

<div class="profile-container">
  <div class="profile-hero">
    <h1>User <span class="accent">Profile</span></h1>
    <p>Manage your account, API keys, and view activity</p>
  </div>

  {% if user %}
  <!-- ‚îÄ‚îÄ Logged-in view ‚îÄ‚îÄ -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('overview', this)">Overview</button>
    <button class="tab-btn" onclick="switchTab('apikeys', this)">API Keys</button>
    <button class="tab-btn" onclick="switchTab('activity', this)" id="tab-activity-btn">Activity</button>
  </div>

  <!-- Overview -->
  <div class="tab-pane active" id="tab-overview">
    <div class="profile-grid">
      <div class="card">
        <div class="avatar" id="avatar-initials">{{ (user.user_name or user.user_id or 'U')[0]|upper }}</div>
        <h3 style="margin-bottom:8px">{{ user.user_name or user.user_id }}</h3>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px">{{ user.user_id }}</div>
        <div class="stat-row"><span class="stat-label">Role</span><span class="stat-val">{{ user.role or 'user' }}</span></div>
        <div class="stat-row">
          <span class="stat-label">Credits</span>
          <span class="stat-val" id="credit-val">{{ user.credit or 0 }}</span>
        </div>
        <div class="credit-bar"><div class="credit-fill" id="credit-bar-fill" style="width:0%"></div></div>
        <div class="stat-row"><span class="stat-label">Tokens</span><span class="stat-val">{{ user.token or 0 }}</span></div>
        <div class="btn-row" style="margin-top:20px">
          <a href="/api/auth/logout" class="btn-outline" style="text-decoration:none;text-align:center">Sign Out</a>
        </div>
      </div>
      <div class="card">
        <h3>Quick Stats</h3>
        <div class="stat-row"><span class="stat-label">Papers Submitted</span><span class="stat-val" id="stat-papers">‚Äî</span></div>
        <div class="stat-row"><span class="stat-label">Reviews Run</span><span class="stat-val" id="stat-reviews">‚Äî</span></div>
        <div class="stat-row"><span class="stat-label">Targeting Assessments</span><span class="stat-val" id="stat-targeting">‚Äî</span></div>
        <div class="stat-row"><span class="stat-label">Arena Papers</span><span class="stat-val" id="stat-arena">‚Äî</span></div>
        <div class="stat-row"><span class="stat-label">API Provider</span><span class="stat-val">{% if user.effective_provider %}{{ user.effective_provider }}{% else %}SSO default{% endif %}</span></div>
        <div class="btn-row" style="margin-top:20px">
          <a href="/scientist" class="btn-primary" style="text-decoration:none">New Paper</a>
          <a href="/targeting" class="btn-outline" style="text-decoration:none">Targeting</a>
        </div>
      </div>
    </div>
  </div>

  <!-- API Keys -->
  <div class="tab-pane" id="tab-apikeys">
    <div class="card">
      <h3>API Key Configuration</h3>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:20px">Override the SSO-provided API key with your own. Your key is stored securely and used for all LLM calls.</p>
      <div class="form-group">
        <label>Provider</label>
        <select id="profile-provider">
          <option value="">Use SSO key (default)</option>
          <option value="comparegpt">CompareGPT</option>
          <option value="openai">OpenAI</option>
          <option value="anthropic">Anthropic</option>
        </select>
      </div>
      <div class="form-group">
        <label>API Key</label>
        <input id="profile-apikey" type="password" placeholder="sk-... or cgpt_...">
      </div>
      <div class="btn-row">
        <button class="btn-primary" onclick="saveProfileKey()">Save API Key</button>
        <button class="btn-danger" onclick="clearProfileKey()">Clear Key</button>
      </div>
      <div class="msg" id="apikey-msg"></div>
    </div>
  </div>

  <!-- Activity -->
  <div class="tab-pane" id="tab-activity">
    <div class="card">
      <h3>Recent Activity</h3>
      <div id="activity-list"><div style="text-align:center;padding:24px;color:var(--text-muted)">Loading activity...</div></div>
    </div>
  </div>

  {% else %}
  <!-- ‚îÄ‚îÄ Logged-out view ‚îÄ‚îÄ -->
  <div class="profile-grid">
    <!-- Sign In -->
    <div class="card">
      <h3>Sign In</h3>
      <a href="/login" class="sso-btn">
        <span class="sso-icon">üîê</span>
        Sign in with CompareGPT SSO
      </a>
      <div class="divider">or use local account</div>
      <div class="form-group"><label>Email / Username</label><input type="text" id="login-username" placeholder="your@email.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div class="btn-row"><button class="btn-primary" onclick="localLogin()" style="width:100%">Sign In</button></div>
      <div class="msg" id="login-msg"></div>
    </div>

    <!-- Register -->
    <div class="card">
      <h3>Create Account</h3>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Register a local account or use CompareGPT SSO for full platform features including AI credits.</p>
      <div class="form-group"><label>Username</label><input type="text" id="reg-username" placeholder="your_username"></div>
      <div class="form-group"><label>Email</label><input type="email" id="reg-email" placeholder="your@email.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="reg-password" placeholder="Choose a strong password"></div>
      <div class="form-group"><label>Confirm Password</label><input type="password" id="reg-confirm" placeholder="Repeat password"></div>
      <div class="btn-row"><button class="btn-primary" onclick="localRegister()" style="width:100%">Create Account</button></div>
      <div class="msg" id="reg-msg"></div>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:12px;color:var(--text-muted)">
        For AI credits and full CompareGPT integration, use <a href="/login" style="color:var(--accent)">SSO sign-in</a>.
      </div>
    </div>
  </div>
  {% endif %}
</div>

<footer>
  <div class="footer-inner">
    <p>aiXiv AI Scientist ‚Äî powered by the SolveEverything.org framework</p>
    <p>Operated by NextGen PlatformAI C Corp</p>
  </div>
</footer>

<script>
function switchTab(id, btn) {
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  btn.classList.add('active');
  if (id === 'activity') loadActivity();
}

// Credit bar
const credit = parseFloat(document.getElementById('credit-val')?.textContent || '0');
const fillEl = document.getElementById('credit-bar-fill');
if (fillEl) fillEl.style.width = Math.min(credit/100*100,100)+'%';

// Quick stats
async function loadStats() {
  try {
    const [papers, dashboard] = await Promise.all([
      fetch('/api/papers').then(r=>r.json()).catch(()=>[]),
      fetch('/api/dashboard').then(r=>r.json()).catch(()=>({})),
    ]);
    document.getElementById('stat-papers').textContent = papers.length || 0;
    document.getElementById('stat-reviews').textContent = dashboard.total_reviews || 0;
    document.getElementById('stat-targeting').textContent = dashboard.total_targeting || 0;
    document.getElementById('stat-arena').textContent = dashboard.arena_papers || 0;
  } catch(e) {}
}

// API key management
async function saveProfileKey() {
  const provider = document.getElementById('profile-provider').value;
  const apiKey = document.getElementById('profile-apikey').value;
  const msg = document.getElementById('apikey-msg');
  try {
    const resp = await fetch('/api/auth/apikey', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({provider, api_key:apiKey})});
    const data = await resp.json();
    msg.className='msg ok'; msg.style.display='block';
    msg.textContent = resp.ok ? 'API key saved!' : (data.detail||'Failed');
    if (!resp.ok) msg.className='msg err';
  } catch(e) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Network error'; }
}

async function clearProfileKey() {
  document.getElementById('profile-provider').value='';
  document.getElementById('profile-apikey').value='';
  await saveProfileKey();
}

// Activity feed
async function loadActivity() {
  const el = document.getElementById('activity-list');
  try {
    const [papers, reviews] = await Promise.all([
      fetch('/api/papers').then(r=>r.json()).catch(()=>[]),
      fetch('/api/papers').then(r=>r.json()).then(ps => Promise.all(ps.slice(0,5).map(p=>
        fetch('/api/reviews/'+encodeURIComponent(p.paper_id)).then(r=>r.json()).catch(()=>({reviews:[]}))
      ))).catch(()=>[]),
    ]);
    let html='';
    papers.slice(0,8).forEach(p=>{
      html+=`<div class="activity-item"><div class="activity-icon">üìÑ</div><div class="activity-text"><strong>${esc(p.title||p.paper_id)}</strong><div style="font-size:12px;color:var(--text-muted)">Submitted ¬∑ ${p.paper_id} ¬∑ ${p.status}</div></div><div class="activity-time">${(p.created_at||'').slice(0,10)}</div></div>`;
    });
    el.innerHTML = html || '<div style="text-align:center;padding:24px;color:var(--text-muted)">No activity yet. <a href="/scientist" style="color:var(--accent)">Submit your first paper.</a></div>';
  } catch(e) { el.innerHTML='<div style="color:var(--text-muted);font-size:13px">Failed to load activity.</div>'; }
}

// Local login
async function localLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const msg = document.getElementById('login-msg');
  if (!username || !password) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Please enter username and password'; return; }
  try {
    const resp = await fetch('/api/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username, password})});
    const data = await resp.json();
    if (resp.ok) { window.location.href='/scientist'; }
    else { msg.className='msg err'; msg.style.display='block'; msg.textContent=data.detail||'Login failed'; }
  } catch(e) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Network error'; }
}

// Local registration
async function localRegister() {
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const confirm = document.getElementById('reg-confirm').value;
  const msg = document.getElementById('reg-msg');
  if (!username || !email || !password) { msg.className='msg err'; msg.style.display='block'; msg.textContent='All fields are required'; return; }
  if (password !== confirm) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Passwords do not match'; return; }
  if (password.length < 8) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Password must be at least 8 characters'; return; }
  try {
    const resp = await fetch('/api/auth/register', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username, email, password})});
    const data = await resp.json();
    if (resp.ok) { msg.className='msg ok'; msg.style.display='block'; msg.textContent='Account created! Signing you in...'; setTimeout(()=>window.location.href='/scientist',1200); }
    else { msg.className='msg err'; msg.style.display='block'; msg.textContent=data.detail||'Registration failed'; }
  } catch(e) { msg.className='msg err'; msg.style.display='block'; msg.textContent='Network error'; }
}

function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// Init
if (document.getElementById('stat-papers')) loadStats();
</script>
</body>
</html>
