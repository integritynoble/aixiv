<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Targeting System - aiXiv</title>
<link rel="stylesheet" href="/static/style.css">
<style>
.targeting-container { max-width: 1000px; margin: 0 auto; padding: 32px 20px; }
.targeting-hero { text-align: center; margin-bottom: 32px; }
.targeting-hero h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
.targeting-hero h1 .accent { color: var(--accent); }
.targeting-hero p { font-size: 15px; color: var(--text-muted); }

.card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); margin-bottom: 20px; }
.card-title { font-size: 16px; font-weight: 700; margin-bottom: 14px; color: var(--text); display: flex; align-items: center; gap: 8px; }

.form-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
.form-group { flex: 1; min-width: 180px; }
.form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.4px; color: var(--text-muted); }
.form-group select, .form-group input { width: 100%; padding: 9px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-family: inherit; box-sizing: border-box; background: var(--card-bg); color: var(--text); }
.btn-primary { background: var(--accent); color: white; border: none; padding: 10px 22px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap; }
.btn-primary:hover { opacity: 0.9; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-sm { padding: 6px 14px; font-size: 13px; border-radius: 5px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; color: var(--text); }
.btn-sm:hover { background: var(--code-bg); }

/* Level colors */
.level-l0 { color: #9e9e9e; }
.level-l1 { color: #f57c00; }
.level-l2 { color: #b8860b; }
.level-l3 { color: #43a047; }
.level-l4 { color: #1565c0; }
.level-l5 { color: #6a1b9a; }

.level-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-l0 { background: #f5f5f5; color: #9e9e9e; }
.badge-l1 { background: #fff3e0; color: #f57c00; }
.badge-l2 { background: #fffde7; color: #b8860b; }
.badge-l3 { background: #e8f5e9; color: #2e7d32; }
.badge-l4 { background: #e3f2fd; color: #1565c0; }
.badge-l5 { background: #f3e5f5; color: #6a1b9a; }

/* Progress bar */
.progress-bar-wrap { margin: 16px 0; }
.progress-bar { display: flex; height: 32px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
.pb-seg { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: white; opacity: 0.25; transition: opacity 0.3s; position: relative; }
.pb-seg.reached { opacity: 1; }
.pb-seg.target-marker::after { content: 'â–¼'; position: absolute; top: -18px; font-size: 12px; color: var(--accent); }
.pb-seg-l0 { background: #9e9e9e; }
.pb-seg-l1 { background: #f57c00; }
.pb-seg-l2 { background: #fbc02d; color: #333; }
.pb-seg-l3 { background: #43a047; }
.pb-seg-l4 { background: #1565c0; }
.pb-seg-l5 { background: #6a1b9a; }
.progress-labels { display: flex; margin-top: 4px; }
.pb-label { flex: 1; text-align: center; font-size: 10px; color: var(--text-muted); }

/* Score display */
.score-display { display: flex; align-items: center; gap: 20px; margin: 12px 0; }
.score-big { font-size: 42px; font-weight: 800; color: var(--accent); line-height: 1; }
.score-sub { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

/* Checklist */
.checklist-section { margin-top: 16px; }
.level-block { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
.level-header { display: flex; align-items: center; gap: 10px; padding: 10px 16px; cursor: pointer; background: var(--code-bg); user-select: none; }
.level-header:hover { background: var(--border); }
.level-chevron { font-size: 11px; transition: transform 0.2s; margin-left: auto; color: var(--text-muted); }
.level-block.open .level-chevron { transform: rotate(90deg); }
.level-name { font-weight: 700; font-size: 14px; }
.level-status { font-size: 12px; color: var(--text-muted); }
.level-items { display: none; padding: 10px 16px; border-top: 1px solid var(--border); }
.level-block.open .level-items { display: block; }
.level-block.dimmed .level-header { opacity: 0.6; }
.check-item { display: flex; align-items: flex-start; gap: 8px; padding: 5px 0; font-size: 13px; line-height: 1.5; }
.check-icon { font-size: 14px; flex-shrink: 0; margin-top: 1px; }
.check-icon.pass { color: #43a047; }
.check-icon.fail { color: #e53935; }

/* Roadmap */
.roadmap-output { background: var(--code-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; min-height: 80px; font-size: 14px; line-height: 1.7; }
.roadmap-output h2 { font-size: 16px; margin-top: 0; }
.roadmap-output h3 { font-size: 14px; margin-top: 12px; }
.roadmap-output ol, .roadmap-output ul { padding-left: 20px; }
.roadmap-output li { margin-bottom: 6px; }
.roadmap-output strong { font-weight: 700; }
.roadmap-output em { font-style: italic; }
.roadmap-actions { display: flex; gap: 8px; margin-top: 10px; }

/* History */
.history-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.history-table th { text-align: left; padding: 8px 12px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px; }
.history-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.history-table tr:hover td { background: var(--code-bg); cursor: pointer; }
.history-table tr.current-row td { font-weight: 600; }

/* Tab bar */
.tab-bar { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
.tab-btn { padding: 8px 18px; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; background: none; border-left: none; border-right: none; border-top: none; }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

.loading { display: none; align-items: center; gap: 8px; padding: 12px 0; color: var(--text-muted); font-size: 14px; }
.loading.show { display: flex; }
.spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.empty-state { text-align: center; padding: 32px; color: var(--text-muted); font-size: 14px; }
.paper-info { font-size: 13px; color: var(--text-muted); margin-top: 6px; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <a href="/" class="logo">ai<span class="logo-accent">X</span>iv</a>
    <nav>
      <a href="/">Papers</a>
      <a href="/scientist">AI Scientist</a>
      <a href="/reviewer">AI Reviewer</a>
      <a href="/pwm">PWM</a>
      <a href="/arena">Arena</a>
      <a href="/targeting" class="active">Targeting</a>
      <a href="/dashboard">Dashboard</a>
    </nav>
  </div>
</header>

{% include "_auth_bar.html" %}
{% include "_settings_modal.html" %}

<div class="targeting-container">

  <div class="targeting-hero">
    <h1>Targeting <span class="accent">System</span></h1>
    <p>Assess your paper's maturity on the L0â€“L5 scale and get a concrete roadmap to advance.</p>
  </div>

  <!-- Paper Selector -->
  <div class="card">
    <div class="card-title">Select Paper &amp; Target</div>
    <div class="form-row">
      <div class="form-group" style="flex:2;">
        <label>Paper</label>
        <select id="paper-select" onchange="onPaperSelect()">
          <option value="">â€” Loading papersâ€¦ â€”</option>
        </select>
      </div>
      <div class="form-group">
        <label>Target Level</label>
        <select id="target-level-select">
          <option value="L1">L1 â€” Measurable</option>
          <option value="L2">L2 â€” Repeatable</option>
          <option value="L3" selected>L3 â€” Automated</option>
          <option value="L4">L4 â€” Industrialized</option>
          <option value="L5">L5 â€” Solved</option>
        </select>
      </div>
      <div>
        <label style="display:block;font-size:12px;font-weight:600;margin-bottom:5px;text-transform:uppercase;letter-spacing:0.4px;color:var(--text-muted);">&nbsp;</label>
        <button class="btn-primary" onclick="runAssessment()" id="assess-btn">â–¶ Run Assessment</button>
      </div>
    </div>
    <div id="paper-info" class="paper-info" style="display:none;"></div>
    <div class="loading" id="assess-loading"><div class="spinner"></div> Running maturity assessmentâ€¦</div>
  </div>

  <!-- Results (hidden until assessed) -->
  <div id="results-section" style="display:none;">

    <!-- Score + Progress -->
    <div class="card">
      <div class="card-title">Maturity Assessment</div>
      <div style="display:flex;align-items:flex-start;gap:32px;flex-wrap:wrap;">
        <div>
          <div style="font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:6px;">Current Level</div>
          <span id="current-level-badge" class="level-badge">â€”</span>
          <div style="font-size:12px;color:var(--text-muted);margin-top:6px;" id="current-level-name"></div>
        </div>
        <div style="flex:1;min-width:220px;">
          <div style="font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:6px;">Targeting Score</div>
          <div class="score-display">
            <div class="score-big" id="score-val">â€”</div>
            <div><div style="font-size:14px;font-weight:600;">/100</div><div class="score-sub" id="score-label">â€”</div></div>
          </div>
        </div>
      </div>

      <div class="progress-bar-wrap" style="margin-top:20px;">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);margin-bottom:6px;">
          <span>Current: <strong id="pb-current">â€”</strong></span>
          <span>Target: <strong id="pb-target">â€”</strong></span>
        </div>
        <div class="progress-bar" id="progress-bar">
          <div class="pb-seg pb-seg-l0" data-level="L0">L0</div>
          <div class="pb-seg pb-seg-l1" data-level="L1">L1</div>
          <div class="pb-seg pb-seg-l2" data-level="L2">L2</div>
          <div class="pb-seg pb-seg-l3" data-level="L3">L3</div>
          <div class="pb-seg pb-seg-l4" data-level="L4">L4</div>
          <div class="pb-seg pb-seg-l5" data-level="L5">L5</div>
        </div>
        <div class="progress-labels">
          <div class="pb-label">Ill-Posed</div>
          <div class="pb-label">Measurable</div>
          <div class="pb-label">Repeatable</div>
          <div class="pb-label">Automated</div>
          <div class="pb-label">Industrialized</div>
          <div class="pb-label">Solved</div>
        </div>
      </div>
    </div>

    <!-- Tabs: Checklist / Roadmap / History -->
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('checklist', this)">Checklist</button>
      <button class="tab-btn" onclick="switchTab('roadmap', this)">Roadmap</button>
      <button class="tab-btn" onclick="switchTab('history', this)" id="history-tab-btn">History</button>
    </div>

    <!-- Checklist Tab -->
    <div class="tab-pane active" id="tab-checklist">
      <div class="checklist-section" id="checklist-container"></div>
    </div>

    <!-- Roadmap Tab -->
    <div class="tab-pane" id="tab-roadmap">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
          <div class="card-title" style="margin-bottom:0;">Roadmap to <span id="roadmap-target-label">â€”</span></div>
          <button class="btn-primary" onclick="generateRoadmap()" id="roadmap-btn">Generate Roadmap â–¶</button>
        </div>
        <div class="loading" id="roadmap-loading"><div class="spinner"></div> Generating roadmapâ€¦</div>
        <div id="roadmap-empty" class="empty-state" style="display:none;">Click "Generate Roadmap" to get an LLM-powered step-by-step plan.</div>
        <div id="roadmap-output" class="roadmap-output" style="display:none;"></div>
        <div class="roadmap-actions" id="roadmap-actions" style="display:none;">
          <button class="btn-sm" onclick="copyRoadmap()">ðŸ“‹ Copy</button>
          <button class="btn-sm" onclick="exportRoadmap()">ðŸ“¥ Export .md</button>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div class="tab-pane" id="tab-history">
      <div class="card">
        <div class="card-title">Assessment History</div>
        <div id="history-empty" class="empty-state" style="display:none;">No past assessments found.</div>
        <table class="history-table" id="history-table" style="display:none;">
          <thead>
            <tr>
              <th>Date</th>
              <th>Level</th>
              <th>Target</th>
              <th>Score</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /results-section -->

</div><!-- /targeting-container -->

<script>
const LEVEL_ORDER = ['L0','L1','L2','L3','L4','L5'];
const LEVEL_NAMES = {
  L0: 'Ill-Posed', L1: 'Measurable', L2: 'Repeatable',
  L3: 'Automated', L4: 'Industrialized', L5: 'Solved'
};
const LEVEL_BADGE_CLASS = {
  L0: 'badge-l0', L1: 'badge-l1', L2: 'badge-l2',
  L3: 'badge-l3', L4: 'badge-l4', L5: 'badge-l5'
};

let currentPaperId = null;
let currentAssessment = null;
let currentRoadmarkText = '';

// â”€â”€ Paper loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPapers() {
  try {
    const resp = await fetch('/api/papers');
    const papers = await resp.json();
    const sel = document.getElementById('paper-select');
    sel.innerHTML = '<option value="">â€” Select a paper â€”</option>';
    for (const p of papers) {
      const opt = document.createElement('option');
      opt.value = p.paper_id;
      opt.textContent = `${p.paper_id} â€” ${p.title.slice(0, 60)}${p.title.length > 60 ? 'â€¦' : ''}`;
      sel.appendChild(opt);
    }
  } catch(e) {
    console.error('Failed to load papers', e);
  }
}

function onPaperSelect() {
  const sel = document.getElementById('paper-select');
  currentPaperId = sel.value;
  document.getElementById('paper-info').style.display = currentPaperId ? 'block' : 'none';
  if (currentPaperId) {
    const opt = sel.options[sel.selectedIndex];
    document.getElementById('paper-info').textContent = `Paper ID: ${currentPaperId}`;
  }
  document.getElementById('results-section').style.display = 'none';
}

// â”€â”€ Assessment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAssessment() {
  if (!currentPaperId) { alert('Please select a paper first.'); return; }
  const targetLevel = document.getElementById('target-level-select').value;
  const btn = document.getElementById('assess-btn');
  const loading = document.getElementById('assess-loading');

  btn.disabled = true;
  loading.classList.add('show');

  try {
    const resp = await fetch(`/api/targeting/assess/${encodeURIComponent(currentPaperId)}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({target_level: targetLevel})
    });
    if (!resp.ok) {
      const err = await resp.json();
      throw new Error(err.detail || 'Assessment failed');
    }
    const data = await resp.json();
    currentAssessment = data;

    // Update target selector to next_level suggestion if applicable
    if (data.next_level) {
      document.getElementById('target-level-select').value = data.next_level;
    }

    renderResults(data);
    document.getElementById('results-section').style.display = 'block';

    // Pre-load history
    loadHistory();

    // Reset roadmap
    document.getElementById('roadmap-output').style.display = 'none';
    document.getElementById('roadmap-actions').style.display = 'none';
    document.getElementById('roadmap-empty').style.display = 'block';
    currentRoadmarkText = '';
    document.getElementById('roadmap-target-label').textContent = targetLevel + ' ' + LEVEL_NAMES[targetLevel];

  } catch(e) {
    alert('Error: ' + e.message);
  } finally {
    btn.disabled = false;
    loading.classList.remove('show');
  }
}

function renderResults(data) {
  const currentLevel = data.current_level || 'L0';
  const targetLevel = document.getElementById('target-level-select').value;
  const score = data.targeting_score || 0;

  // Badge
  const badge = document.getElementById('current-level-badge');
  badge.textContent = `${currentLevel} â€” ${LEVEL_NAMES[currentLevel] || ''}`;
  badge.className = 'level-badge ' + (LEVEL_BADGE_CLASS[currentLevel] || '');
  document.getElementById('current-level-name').textContent = '';

  // Score
  document.getElementById('score-val').textContent = Math.round(score);
  document.getElementById('score-label').textContent = getScoreLabel(score);

  // Progress bar
  const curIdx = LEVEL_ORDER.indexOf(currentLevel);
  const tgtIdx = LEVEL_ORDER.indexOf(targetLevel);
  document.getElementById('pb-current').textContent = currentLevel;
  document.getElementById('pb-target').textContent = targetLevel;
  document.querySelectorAll('.pb-seg').forEach((seg, i) => {
    seg.classList.remove('reached', 'target-marker');
    if (i <= curIdx) seg.classList.add('reached');
    if (i === tgtIdx) seg.classList.add('target-marker');
  });

  // Checklist
  renderChecklist(data.maturity_assessment || {}, currentLevel);
}

function getScoreLabel(score) {
  if (score >= 80) return 'Excellent';
  if (score >= 60) return 'Good progress';
  if (score >= 40) return 'Developing';
  if (score >= 20) return 'Early stage';
  return 'Just starting';
}

// â”€â”€ Checklist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChecklist(assessment, currentLevel) {
  const container = document.getElementById('checklist-container');
  container.innerHTML = '';
  const curIdx = LEVEL_ORDER.indexOf(currentLevel);

  LEVEL_ORDER.forEach((level, idx) => {
    const levelData = assessment[level] || {};
    const satisfied = levelData.satisfied || [];
    const missing = levelData.missing || [];
    const passes = levelData.passes || false;
    const isAtOrBelow = idx <= curIdx;

    const block = document.createElement('div');
    block.className = 'level-block' + (isAtOrBelow ? ' open' : ' dimmed');

    const passIcon = passes ? 'âœ“' : 'âœ—';
    const passColor = passes ? 'color:#43a047' : 'color:#e53935';
    const missingCount = missing.length;
    const statusText = passes
      ? `PASSED`
      : isAtOrBelow
        ? `NOT PASSED (need more items)`
        : `NOT REACHED (${missingCount} item${missingCount !== 1 ? 's' : ''} missing)`;

    block.innerHTML = `
      <div class="level-header" onclick="toggleLevel(this)">
        <span class="level-badge ${LEVEL_BADGE_CLASS[level] || ''}">${level}</span>
        <span class="level-name">${LEVEL_NAMES[level]}</span>
        <span class="level-status" style="${passColor}">${passIcon} ${statusText}</span>
        <span class="level-chevron">â–¶</span>
      </div>
      <div class="level-items">
        ${satisfied.map(item => `
          <div class="check-item">
            <span class="check-icon pass">âœ“</span>
            <span>${escapeHtml(item)}</span>
          </div>`).join('')}
        ${missing.map(item => `
          <div class="check-item">
            <span class="check-icon fail">âœ—</span>
            <span>${escapeHtml(item)}</span>
          </div>`).join('')}
        ${satisfied.length === 0 && missing.length === 0
          ? '<div style="color:var(--text-muted);font-size:13px;padding:4px 0;">No items evaluated yet.</div>'
          : ''}
      </div>`;

    container.appendChild(block);
  });
}

function toggleLevel(header) {
  header.closest('.level-block').classList.toggle('open');
}

// â”€â”€ Roadmap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateRoadmap() {
  if (!currentPaperId || !currentAssessment) { alert('Run an assessment first.'); return; }
  const targetLevel = document.getElementById('target-level-select').value;
  const currentLevel = currentAssessment.current_level;

  // Collect gap items from current+1 through target
  const curIdx = LEVEL_ORDER.indexOf(currentLevel);
  const tgtIdx = LEVEL_ORDER.indexOf(targetLevel);
  const gapItems = [];
  const assessment = currentAssessment.maturity_assessment || {};
  for (let i = curIdx + 1; i <= tgtIdx; i++) {
    const lvl = LEVEL_ORDER[i];
    const missing = (assessment[lvl] || {}).missing || [];
    gapItems.push(...missing);
  }
  // Also add missing items from current level (if it doesn't fully pass)
  const curMissing = (assessment[currentLevel] || {}).missing || [];
  gapItems.unshift(...curMissing);

  const btn = document.getElementById('roadmap-btn');
  const loading = document.getElementById('roadmap-loading');
  btn.disabled = true;
  loading.classList.add('show');
  document.getElementById('roadmap-empty').style.display = 'none';
  document.getElementById('roadmap-output').style.display = 'none';
  document.getElementById('roadmap-actions').style.display = 'none';

  try {
    const resp = await fetch(`/api/targeting/roadmap/${encodeURIComponent(currentPaperId)}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        current_level: currentLevel,
        target_level: targetLevel,
        gap_items: gapItems,
      })
    });
    if (!resp.ok) {
      const err = await resp.json();
      throw new Error(err.detail || 'Roadmap generation failed');
    }
    const data = await resp.json();
    currentRoadmarkText = data.roadmap || '';

    document.getElementById('roadmap-output').innerHTML = renderMarkdown(currentRoadmarkText);
    document.getElementById('roadmap-output').style.display = 'block';
    document.getElementById('roadmap-actions').style.display = 'flex';
    document.getElementById('roadmap-target-label').textContent = targetLevel + ' ' + LEVEL_NAMES[targetLevel];
  } catch(e) {
    alert('Error: ' + e.message);
    document.getElementById('roadmap-empty').style.display = 'block';
  } finally {
    btn.disabled = false;
    loading.classList.remove('show');
  }
}

function copyRoadmap() {
  if (!currentRoadmarkText) return;
  navigator.clipboard.writeText(currentRoadmarkText).then(() => {
    const btn = event.target;
    btn.textContent = 'âœ“ Copied';
    setTimeout(() => { btn.textContent = 'ðŸ“‹ Copy'; }, 1500);
  });
}

function exportRoadmap() {
  if (!currentRoadmarkText) return;
  const blob = new Blob([currentRoadmarkText], {type: 'text/markdown'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const pid = (currentPaperId || 'paper').replace(/[^a-zA-Z0-9_-]/g, '_');
  a.download = `roadmap_${pid}.md`;
  a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  if (!currentPaperId) return;
  try {
    const resp = await fetch(`/api/targeting/history/${encodeURIComponent(currentPaperId)}`);
    const rows = await resp.json();
    const tbody = document.getElementById('history-body');
    const table = document.getElementById('history-table');
    const empty = document.getElementById('history-empty');
    tbody.innerHTML = '';

    if (!rows.length) {
      table.style.display = 'none';
      empty.style.display = 'block';
      document.getElementById('history-tab-btn').textContent = 'History';
      return;
    }

    document.getElementById('history-tab-btn').textContent = `History [${rows.length}]`;
    table.style.display = 'table';
    empty.style.display = 'none';

    rows.forEach((row, idx) => {
      const tr = document.createElement('tr');
      if (idx === 0) tr.className = 'current-row';
      const dateStr = row.created_at ? row.created_at.slice(0, 16).replace('T', ' ') : 'â€”';
      const levelBadge = `<span class="level-badge ${LEVEL_BADGE_CLASS[row.current_level] || ''}">${row.current_level}</span>`;
      tr.innerHTML = `
        <td>${dateStr}</td>
        <td>${levelBadge}</td>
        <td>${row.target_level || 'â€”'}</td>
        <td>${Math.round(row.targeting_score || 0)}</td>
        <td><button class="btn-sm" onclick="viewHistoryEntry(${JSON.stringify(JSON.stringify(row))})">view</button></td>
      `;
      tbody.appendChild(tr);
    });
  } catch(e) {
    console.error('Failed to load history', e);
  }
}

function viewHistoryEntry(rowJson) {
  const row = JSON.parse(rowJson);
  const assessment = typeof row.assessment_json === 'string'
    ? JSON.parse(row.assessment_json)
    : row.assessment_json;
  const mockData = {
    current_level: row.current_level,
    targeting_score: row.targeting_score,
    maturity_assessment: assessment,
    next_level: row.target_level,
  };
  // Temporarily set target level selector
  if (row.target_level) document.getElementById('target-level-select').value = row.target_level;
  renderResults(mockData);
  switchTab('checklist', document.querySelector('.tab-btn'));
}

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tabId, btn) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  btn.classList.add('active');
  if (tabId === 'history') loadHistory();
}

function escapeHtml(text) {
  return (text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderMarkdown(md) {
  // Basic markdown rendering: headers, bold, italic, lists, line breaks
  let html = escapeHtml(md);
  // Headers
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');
  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Numbered list items
  html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  // Bullet list items
  html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
  // Wrap consecutive <li> in <ol> or <ul>
  html = html.replace(/(<li>.*?<\/li>)(\n<li>.*?<\/li>)*/gs, (match) => `<ol>${match}</ol>`);
  // Paragraphs: double newlines
  html = html.replace(/\n\n/g, '</p><p>');
  html = '<p>' + html + '</p>';
  // Clean up empty paragraphs
  html = html.replace(/<p>\s*<\/p>/g, '');
  html = html.replace(/<p>(<h[23]>)/g, '$1');
  html = html.replace(/(<\/h[23]>)<\/p>/g, '$1');
  html = html.replace(/<p>(<ol>)/g, '$1');
  html = html.replace(/(<\/ol>)<\/p>/g, '$1');
  return html;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadPapers();
</script>

</body>
</html>
